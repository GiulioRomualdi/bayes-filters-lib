The following snippet code shows how to run an Unscented Particle Filter (U\+PF) using the implementation provided by the library.~\newline



\begin{DoxyCodeInclude}{0}
\DoxyCodeLine{1 \textcolor{comment}{/*}}
\DoxyCodeLine{2 \textcolor{comment}{ * Copyright (C) 2016-\/2019 Istituto Italiano di Tecnologia (IIT)}}
\DoxyCodeLine{3 \textcolor{comment}{ *}}
\DoxyCodeLine{4 \textcolor{comment}{ * This software may be modified and distributed under the terms of the}}
\DoxyCodeLine{5 \textcolor{comment}{ * BSD 3-\/Clause license. See the accompanying LICENSE file for details.}}
\DoxyCodeLine{6 \textcolor{comment}{ */}}
\DoxyCodeLine{7 }
\DoxyCodeLine{8 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{AdditiveStateModel_8h}{BayesFilters/AdditiveStateModel.h}}>}}
\DoxyCodeLine{9 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{EstimatesExtraction_8h}{BayesFilters/EstimatesExtraction.h}}>}}
\DoxyCodeLine{10 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{GaussianLikelihood_8h}{BayesFilters/GaussianLikelihood.h}}>}}
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{GPFPrediction_8h}{BayesFilters/GPFPrediction.h}}>}}
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{GPFCorrection_8h}{BayesFilters/GPFCorrection.h}}>}}
\DoxyCodeLine{13 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{InitSurveillanceAreaGrid_8h}{BayesFilters/InitSurveillanceAreaGrid.h}}>}}
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{Resampling_8h}{BayesFilters/Resampling.h}}>}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{SimulatedLinearSensor_8h}{BayesFilters/SimulatedLinearSensor.h}}>}}
\DoxyCodeLine{16 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{SimulatedStateModel_8h}{BayesFilters/SimulatedStateModel.h}}>}}
\DoxyCodeLine{17 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{SIS_8h}{BayesFilters/SIS.h}}>}}
\DoxyCodeLine{18 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{UKFPrediction_8h}{BayesFilters/UKFPrediction.h}}>}}
\DoxyCodeLine{19 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{UKFCorrection_8h}{BayesFilters/UKFCorrection.h}}>}}
\DoxyCodeLine{20 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{utils_8h}{BayesFilters/utils.h}}>}}
\DoxyCodeLine{21 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{WhiteNoiseAcceleration_8h}{BayesFilters/WhiteNoiseAcceleration.h}}>}}
\DoxyCodeLine{22 }
\DoxyCodeLine{23 \textcolor{preprocessor}{\#include <iostream>}}
\DoxyCodeLine{24 \textcolor{preprocessor}{\#include <memory>}}
\DoxyCodeLine{25 \textcolor{preprocessor}{\#include <string>}}
\DoxyCodeLine{26 }
\DoxyCodeLine{27 \textcolor{preprocessor}{\#include <Eigen/Dense>}}
\DoxyCodeLine{28 }
\DoxyCodeLine{29 \textcolor{keyword}{using namespace }\mbox{\hyperlink{namespacebfl}{bfl}};}
\DoxyCodeLine{30 \textcolor{keyword}{using namespace }Eigen;}
\DoxyCodeLine{31 }
\DoxyCodeLine{32 }
\DoxyCodeLine{33 \textcolor{keyword}{class }UPFSimulation : \textcolor{keyword}{public} \mbox{\hyperlink{classbfl_1_1SIS}{SIS}}}
\DoxyCodeLine{34 \{}
\DoxyCodeLine{35 \textcolor{keyword}{public}:}
\DoxyCodeLine{36     UPFSimulation}
\DoxyCodeLine{37     (}
\DoxyCodeLine{38         std::size\_t num\_particle,}
\DoxyCodeLine{39         std::size\_t state\_size,}
\DoxyCodeLine{40         std::size\_t simulation\_steps,}
\DoxyCodeLine{41         \textcolor{comment}{/* Initial covariance of the Gaussian belief associated to each particle. */}}
\DoxyCodeLine{42         Ref<MatrixXd> initial\_covariance,}
\DoxyCodeLine{43         std::unique\_ptr<ParticleSetInitialization> initialization,}
\DoxyCodeLine{44         std::unique\_ptr<PFPrediction> prediction,}
\DoxyCodeLine{45         std::unique\_ptr<PFCorrection> correction,}
\DoxyCodeLine{46         std::unique\_ptr<Resampling> resampling}
\DoxyCodeLine{47     ) noexcept :}
\DoxyCodeLine{48         \mbox{\hyperlink{classbfl_1_1SIS}{SIS}}(num\_particle, state\_size, std::move(initialization), std::move(prediction), std::move(correction), std::move(resampling)),}
\DoxyCodeLine{49         simulation\_steps\_(simulation\_steps),}
\DoxyCodeLine{50         initial\_covariance\_(initial\_covariance),}
\DoxyCodeLine{51         estimates\_extraction\_(state\_size)}
\DoxyCodeLine{52     \{ \}}
\DoxyCodeLine{53 }
\DoxyCodeLine{54 \textcolor{keyword}{protected}:}
\DoxyCodeLine{55     \textcolor{keywordtype}{bool} run\_condition()\textcolor{keyword}{ override}}
\DoxyCodeLine{56 \textcolor{keyword}{    }\{}
\DoxyCodeLine{57         \textcolor{keywordflow}{if} (step\_number() < simulation\_steps\_)}
\DoxyCodeLine{58             \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{59         \textcolor{keywordflow}{else}}
\DoxyCodeLine{60             \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{61     \}}
\DoxyCodeLine{62 }
\DoxyCodeLine{63     std::vector<std::string> log\_file\_names(\textcolor{keyword}{const} std::string\& folder\_path, \textcolor{keyword}{const} std::string\& file\_name\_prefix)\textcolor{keyword}{ override}}
\DoxyCodeLine{64 \textcolor{keyword}{    }\{}
\DoxyCodeLine{65         std::vector<std::string> sis\_filenames = \mbox{\hyperlink{classbfl_1_1SIS_a5ea76b03f1add313c42552ec24bf1f2f}{SIS::log\_file\_names}}(folder\_path, file\_name\_prefix);}
\DoxyCodeLine{66 }
\DoxyCodeLine{67         \textcolor{comment}{/* Add file names for logging of the conditional expected value. */}}
\DoxyCodeLine{68         sis\_filenames.push\_back(folder\_path + \textcolor{stringliteral}{"/"} + file\_name\_prefix + \textcolor{stringliteral}{"\_mean"});}
\DoxyCodeLine{69 }
\DoxyCodeLine{70         \textcolor{keywordflow}{return}  sis\_filenames;}
\DoxyCodeLine{71     \}}
\DoxyCodeLine{72 }
\DoxyCodeLine{73     \textcolor{keywordtype}{bool} initialization\_step()\textcolor{keyword}{ override}}
\DoxyCodeLine{74 \textcolor{keyword}{    }\{}
\DoxyCodeLine{75         estimates\_extraction\_.setMethod(\mbox{\hyperlink{classbfl_1_1EstimatesExtraction_a8489976af4025f0bbc3288ff7f17ffb0ab93db188572fc4d76cce5660f3823b0a}{EstimatesExtraction::ExtractionMethod::mean}});}
\DoxyCodeLine{76 }
\DoxyCodeLine{77         \textcolor{keywordflow}{if} (!\mbox{\hyperlink{classbfl_1_1SIS_a2365c40d6d150e57012f3d745e20c4ea}{SIS::initialization\_step}}())}
\DoxyCodeLine{78             \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{79 }
\DoxyCodeLine{80         \textcolor{comment}{/* Initialize initial mean and covariance for each particle. */}}
\DoxyCodeLine{81         \textcolor{keywordflow}{for} (std::size\_t i = 0; i < pred\_particle\_.components; i++)}
\DoxyCodeLine{82         \{}
\DoxyCodeLine{83             \textcolor{comment}{/* Set mean equal to the particle position. */}}
\DoxyCodeLine{84             pred\_particle\_.mean(i) = pred\_particle\_.state(i);}
\DoxyCodeLine{85 }
\DoxyCodeLine{86             \textcolor{comment}{/* Set the covariance obtained within the ctor. */}}
\DoxyCodeLine{87             pred\_particle\_.covariance(i) = initial\_covariance\_;}
\DoxyCodeLine{88         \}}
\DoxyCodeLine{89 }
\DoxyCodeLine{90         \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{91     \}}
\DoxyCodeLine{92 }
\DoxyCodeLine{93     \textcolor{keywordtype}{void} log()\textcolor{keyword}{ override}}
\DoxyCodeLine{94 \textcolor{keyword}{    }\{}
\DoxyCodeLine{95         VectorXd mean;}
\DoxyCodeLine{96         std::tie(std::ignore, mean) = estimates\_extraction\_.extract(cor\_particle\_.state(), cor\_particle\_.weight());}
\DoxyCodeLine{97 }
\DoxyCodeLine{98         logger(pred\_particle\_.state().transpose(), pred\_particle\_.weight().transpose(),}
\DoxyCodeLine{99                cor\_particle\_.state().transpose(), cor\_particle\_.weight().transpose(),}
\DoxyCodeLine{100                mean.transpose());}
\DoxyCodeLine{101     \}}
\DoxyCodeLine{102 }
\DoxyCodeLine{103 \textcolor{keyword}{private}:}
\DoxyCodeLine{104     std::size\_t simulation\_steps\_;}
\DoxyCodeLine{105 }
\DoxyCodeLine{106     Eigen::MatrixXd initial\_covariance\_;}
\DoxyCodeLine{107 }
\DoxyCodeLine{108     \mbox{\hyperlink{classbfl_1_1EstimatesExtraction}{EstimatesExtraction}} estimates\_extraction\_;}
\DoxyCodeLine{109 \};}
\DoxyCodeLine{110 }
\DoxyCodeLine{111 }
\DoxyCodeLine{112 \textcolor{keywordtype}{int} main(\textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char}* argv[])}
\DoxyCodeLine{113 \{}
\DoxyCodeLine{114     std::cout << \textcolor{stringliteral}{"Running an unscented particle filter on a simulated target."} << std::endl;}
\DoxyCodeLine{115 }
\DoxyCodeLine{116     \textcolor{keyword}{const} \textcolor{keywordtype}{bool} write\_to\_file = (argc > 1 ? std::string(argv[1]) == \textcolor{stringliteral}{"ON"} : \textcolor{keyword}{false});}
\DoxyCodeLine{117     \textcolor{keywordflow}{if} (write\_to\_file)}
\DoxyCodeLine{118         std::cout << \textcolor{stringliteral}{"Data is logged in the test folder with prefix testUPF."} << std::endl;}
\DoxyCodeLine{119 }
\DoxyCodeLine{120 }
\DoxyCodeLine{121     \textcolor{comment}{/* A set of parameters needed to run an unscented particle filter in a simulated environment. */}}
\DoxyCodeLine{122     \textcolor{keywordtype}{double} surv\_x = 1000.0;}
\DoxyCodeLine{123     \textcolor{keywordtype}{double} surv\_y = 1000.0;}
\DoxyCodeLine{124     std::size\_t num\_particle\_x = 7;}
\DoxyCodeLine{125     std::size\_t num\_particle\_y = 7;}
\DoxyCodeLine{126     std::size\_t num\_particle = num\_particle\_x * num\_particle\_y;}
\DoxyCodeLine{127     Vector4d initial\_state(10.0f, 0.0f, 10.0f, 0.0f);}
\DoxyCodeLine{128     std::size\_t simulation\_time = 100;}
\DoxyCodeLine{129     std::size\_t state\_size = 4;}
\DoxyCodeLine{130 }
\DoxyCodeLine{131     \textcolor{comment}{/* Unscented transform parameters.*/}}
\DoxyCodeLine{132     \textcolor{keywordtype}{double} alpha = 1.0;}
\DoxyCodeLine{133     \textcolor{keywordtype}{double} beta = 2.0;}
\DoxyCodeLine{134     \textcolor{keywordtype}{double} kappa = 0.0;}
\DoxyCodeLine{135 }
\DoxyCodeLine{136     \textcolor{comment}{/* Step 1 -\/ Initialization */}}
\DoxyCodeLine{137 }
\DoxyCodeLine{138     Matrix4d initial\_covariance;}
\DoxyCodeLine{139     initial\_covariance << pow(0.05, 2), 0,            0,            0,}
\DoxyCodeLine{140                           0,            pow(0.05, 2), 0,            0,}
\DoxyCodeLine{141                           0,            0,            pow(0.01, 2), 0,}
\DoxyCodeLine{142                           0,            0,            0,            pow(0.01, 2);}
\DoxyCodeLine{143 }
\DoxyCodeLine{144     \textcolor{comment}{/* Initialize particle initialization class. */}}
\DoxyCodeLine{145     std::unique\_ptr<ParticleSetInitialization> grid\_initialization = utils::make\_unique<InitSurveillanceAreaGrid>(surv\_x, surv\_y, num\_particle\_x, num\_particle\_y);}
\DoxyCodeLine{146 }
\DoxyCodeLine{147 }
\DoxyCodeLine{148     \textcolor{comment}{/* Step 2 -\/ Prediction */}}
\DoxyCodeLine{149 }
\DoxyCodeLine{150     \textcolor{comment}{/* Step 2.1 -\/ Define the state model. */}}
\DoxyCodeLine{151 }
\DoxyCodeLine{152     \textcolor{comment}{/* Initialize a white noise acceleration state model. */}}
\DoxyCodeLine{153     \textcolor{keywordtype}{double} T = 1.0f;}
\DoxyCodeLine{154     \textcolor{keywordtype}{double} tilde\_q = 10.0f;}
\DoxyCodeLine{155 }
\DoxyCodeLine{156     std::unique\_ptr<AdditiveStateModel> wna = utils::make\_unique<WhiteNoiseAcceleration>(\mbox{\hyperlink{classbfl_1_1WhiteNoiseAcceleration_ad38237bda14ccceba94d06ac1155f3cea7fec533aaab2dc4c675964c8ff8a747b}{WhiteNoiseAcceleration::Dim::TwoD}}, T, tilde\_q);}
\DoxyCodeLine{157 }
\DoxyCodeLine{158     \textcolor{comment}{/* Step 2.2 -\/ Define the prediction step */}}
\DoxyCodeLine{159 }
\DoxyCodeLine{160     \textcolor{comment}{/* Initialize the kalman particle filter prediction step that wraps a Gaussian prediction step,}}
\DoxyCodeLine{161 \textcolor{comment}{       in this case an unscented kalman filter prediction step. */}}
\DoxyCodeLine{162     std::unique\_ptr<GaussianPrediction> upf\_prediction = utils::make\_unique<UKFPrediction>(std::move(wna), alpha, beta, kappa);}
\DoxyCodeLine{163     std::unique\_ptr<PFPrediction> gpf\_prediction = utils::make\_unique<GPFPrediction>(std::move(upf\_prediction));}
\DoxyCodeLine{164 }
\DoxyCodeLine{165 }
\DoxyCodeLine{166     \textcolor{comment}{/* Step 3 -\/ Correction */}}
\DoxyCodeLine{167 }
\DoxyCodeLine{168     \textcolor{comment}{/* Step 3.1 -\/ Define where the measurement are originated from (simulated in this case). */}}
\DoxyCodeLine{169 }
\DoxyCodeLine{170     \textcolor{comment}{/* Initialize simulated target model with a white noise acceleration. */}}
\DoxyCodeLine{171     std::unique\_ptr<StateModel> target\_model = utils::make\_unique<WhiteNoiseAcceleration>(\mbox{\hyperlink{classbfl_1_1WhiteNoiseAcceleration_ad38237bda14ccceba94d06ac1155f3cea7fec533aaab2dc4c675964c8ff8a747b}{WhiteNoiseAcceleration::Dim::TwoD}}, T, tilde\_q);}
\DoxyCodeLine{172     std::unique\_ptr<SimulatedStateModel> simulated\_state\_model = utils::make\_unique<SimulatedStateModel>(std::move(target\_model), initial\_state, simulation\_time);}
\DoxyCodeLine{173 }
\DoxyCodeLine{174     \textcolor{keywordflow}{if} (write\_to\_file)}
\DoxyCodeLine{175         simulated\_state\_model-\/>enable\_log(\textcolor{stringliteral}{"./"}, \textcolor{stringliteral}{"testUPF"});}
\DoxyCodeLine{176 }
\DoxyCodeLine{177     \textcolor{comment}{/* Initialize a measurement model (a linear sensor reading x and y coordinates). */}}
\DoxyCodeLine{178     \textcolor{keywordtype}{double} sigma\_x = 10.0;}
\DoxyCodeLine{179     \textcolor{keywordtype}{double} sigma\_y = 10.0;}
\DoxyCodeLine{180     Eigen::MatrixXd R(2, 2);}
\DoxyCodeLine{181     R << std::pow(sigma\_x, 2.0),                    0.0,}
\DoxyCodeLine{182                             0.0, std::pow(sigma\_y, 2.0);}
\DoxyCodeLine{183 }
\DoxyCodeLine{184     std::unique\_ptr<AdditiveMeasurementModel> simulated\_linear\_sensor = utils::make\_unique<SimulatedLinearSensor>(std::move(simulated\_state\_model), \mbox{\hyperlink{classbfl_1_1LinearModel_a35a55d925652256ca6865a4b324315ee}{SimulatedLinearSensor::LinearMatrixComponent}}\{ 4, std::vector<std::size\_t>\{ 0, 2 \} \}, R);}
\DoxyCodeLine{185 }
\DoxyCodeLine{186     \textcolor{keywordflow}{if} (write\_to\_file)}
\DoxyCodeLine{187         simulated\_linear\_sensor-\/>enable\_log(\textcolor{stringliteral}{"./"}, \textcolor{stringliteral}{"testUPF"});}
\DoxyCodeLine{188 }
\DoxyCodeLine{189 }
\DoxyCodeLine{190     \textcolor{comment}{/* Step 3.2 -\/ Define the likelihood model. */}}
\DoxyCodeLine{191 }
\DoxyCodeLine{192     \textcolor{comment}{/* Initialize an exponential likelihood as measurement likelihood. */}}
\DoxyCodeLine{193     std::unique\_ptr<LikelihoodModel> exp\_likelihood = utils::make\_unique<GaussianLikelihood>();}
\DoxyCodeLine{194 }
\DoxyCodeLine{195     \textcolor{comment}{/* Step 3.3 -\/ Define the correction step. */}}
\DoxyCodeLine{196 }
\DoxyCodeLine{197     \textcolor{comment}{/* An additional state model is required to make the transitionProbability of the state model available}}
\DoxyCodeLine{198 \textcolor{comment}{       to the particle filter correction step. */}}
\DoxyCodeLine{199     std::unique\_ptr<StateModel> transition\_probability\_model = utils::make\_unique<WhiteNoiseAcceleration>(\mbox{\hyperlink{classbfl_1_1WhiteNoiseAcceleration_ad38237bda14ccceba94d06ac1155f3cea7fec533aaab2dc4c675964c8ff8a747b}{WhiteNoiseAcceleration::Dim::TwoD}}, T, tilde\_q);}
\DoxyCodeLine{200 }
\DoxyCodeLine{201     \textcolor{comment}{/* Initialize the particle filter correction step that wraps a Guassian correction step,}}
\DoxyCodeLine{202 \textcolor{comment}{       in this case an unscented kalman filter correction step. */}}
\DoxyCodeLine{203     std::unique\_ptr<GaussianCorrection> upf\_correction = utils::make\_unique<UKFCorrection>(std::move(simulated\_linear\_sensor), alpha, beta, kappa);}
\DoxyCodeLine{204     std::unique\_ptr<PFCorrection> gpf\_correction = utils::make\_unique<GPFCorrection>(std::move(exp\_likelihood), std::move(upf\_correction), std::move(transition\_probability\_model));}
\DoxyCodeLine{205 }
\DoxyCodeLine{206 }
\DoxyCodeLine{207     \textcolor{comment}{/* Step 4 -\/ Resampling */}}
\DoxyCodeLine{208 }
\DoxyCodeLine{209     \textcolor{comment}{/* Initialize a resampling algorithm. */}}
\DoxyCodeLine{210     std::unique\_ptr<Resampling> resampling = utils::make\_unique<Resampling>();}
\DoxyCodeLine{211 }
\DoxyCodeLine{212 }
\DoxyCodeLine{213     \textcolor{comment}{/* Step 5 -\/ Assemble the particle filter. */}}
\DoxyCodeLine{214     std::cout << \textcolor{stringliteral}{"Constructing unscented particle filter..."} << std::flush;}
\DoxyCodeLine{215 }
\DoxyCodeLine{216     UPFSimulation upf(num\_particle, state\_size, simulation\_time, initial\_covariance, std::move(grid\_initialization), std::move(gpf\_prediction), std::move(gpf\_correction), std::move(resampling));}
\DoxyCodeLine{217 }
\DoxyCodeLine{218     \textcolor{keywordflow}{if} (write\_to\_file)}
\DoxyCodeLine{219         upf.enable\_log(\textcolor{stringliteral}{"./"}, \textcolor{stringliteral}{"testUPF"});}
\DoxyCodeLine{220 }
\DoxyCodeLine{221     std::cout << \textcolor{stringliteral}{"done!"} << std::endl;}
\DoxyCodeLine{222 }
\DoxyCodeLine{223 }
\DoxyCodeLine{224     \textcolor{comment}{/* Step 6 -\/ Prepare the filter to be run */}}
\DoxyCodeLine{225     std::cout << \textcolor{stringliteral}{"Booting unscented particle filter..."} << std::flush;}
\DoxyCodeLine{226 }
\DoxyCodeLine{227     upf.boot();}
\DoxyCodeLine{228 }
\DoxyCodeLine{229     std::cout << \textcolor{stringliteral}{"completed!"} << std::endl;}
\DoxyCodeLine{230 }
\DoxyCodeLine{231 }
\DoxyCodeLine{232     \textcolor{comment}{/* Step 7 -\/ Run the filter and wait until it is closed */}}
\DoxyCodeLine{233     \textcolor{comment}{/* Note that since this is a simulation, the filter will end upon simulation termination */}}
\DoxyCodeLine{234     std::cout << \textcolor{stringliteral}{"Running unscented particle filter..."} << std::flush;}
\DoxyCodeLine{235 }
\DoxyCodeLine{236     upf.run();}
\DoxyCodeLine{237 }
\DoxyCodeLine{238     std::cout << \textcolor{stringliteral}{"waiting..."} << std::flush;}
\DoxyCodeLine{239 }
\DoxyCodeLine{240     \textcolor{keywordflow}{if} (!upf.wait())}
\DoxyCodeLine{241         \textcolor{keywordflow}{return} EXIT\_FAILURE;}
\DoxyCodeLine{242 }
\DoxyCodeLine{243     std::cout << \textcolor{stringliteral}{"completed!"} << std::endl;}
\DoxyCodeLine{244 }
\DoxyCodeLine{245     \textcolor{keywordflow}{return} EXIT\_SUCCESS;}
\DoxyCodeLine{246 \}}
\end{DoxyCodeInclude}
 